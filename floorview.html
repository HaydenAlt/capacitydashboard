<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HPCCSS Room Capacity Dashboard - Floor View</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f7fafc;
        }
        .floor-plan-container {
            position: relative;
            max-width: 100%;
            height: auto;
            margin: 0 auto;
        }
        .floor-plan {
            width: 100%;
            height: auto;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .room-marker {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid white;
            transition: all 0.2s ease-in-out;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.5);
        }
        .room-marker:hover {
            transform: translate(-50%, -50%) scale(1.2);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.8), 0 0 10px var(--marker-color);
            z-index: 10;
        }
        .room-marker-blink {
            animation: pulse-border 1.5s infinite;
        }
        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 255, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
        }
    </style>
    <script>
        const TRANSLATIONS = {
            'en': {
                'title': 'Interactive Occupancy Monitor',
                'subtitle': 'Select a floor plan and click on a room to view real-time capacity.',
                'refresh_data': 'Refresh Data',
                'loading': 'Loading...',
                'fetching_data': 'Fetching real-time data...',
                'error_loading': 'Error loading data. Check console.',
                'select_floor': 'Select Floor:',
                'room_details': 'Room Details',
                'floor': 'Floor',
                'room_id_label': 'Room ID',
                'capacity_label': 'Capacity',
                'people_label': 'people',
                'error_api': 'Error fetching data from API.',
                'no_room_selected': 'Click on a room marker on the map to see its details.',
                'not_found': 'Room data not found.',
                'floor_G': 'Ground Floor (G/F)',
                'floor_1': '1st Floor (1/F)',
                'list_view_mode': 'List View Mode',
                'current_occupancy': 'Current Occupancy'
            },
            'zh': {
                'title': '互動佔用監控',
                'subtitle': '選擇樓層平面圖並點擊房間以查看實時容量。',
                'refresh_data': '刷新數據',
                'loading': '載入中...',
                'fetching_data': '正在獲取實時數據...',
                'error_loading': '載入數據錯誤。請在 console 檢查。',
                'select_floor': '選擇樓層：',
                'room_details': '房間詳情',
                'floor': '樓層',
                'room_id_label': '房間編號',
                'capacity_label': '容量',
                'people_label': '人',
                'error_api': '從 API 獲取數據錯誤。',
                'no_room_selected': '點擊地圖上的房間標記以查看其詳情。',
                'not_found': '找不到房間數據。',
                'floor_G': '地下 (G/F)',
                'floor_1': '一樓 (1/F)',
                'list_view_mode': '列表視圖模式',
                'current_occupancy': '當前佔用人數'
            }
        };

        const LIST_VIEW_URL = 'https://haydenalt.github.io/capacitydashboard/';

        const ROOM_CONFIG = [
            { room_id: "101", name: "Training Room Alpha", name_zh: "甲級培訓室", max_capacity: 10, floor_label: "1/F", x: 15, y: 20 },
            { room_id: "102", name: "Meeting Room Beta", name_zh: "乙級會議室", max_capacity: 15, floor_label: "1/F", x: 40, y: 15 },
            { room_id: "103", name: "Studio Gamma", name_zh: "丙級工作室", max_capacity: 20, floor_label: "1/F", x: 70, y: 25 },
            { room_id: "104", name: "Lounge Delta", name_zh: "丁級休息室", max_capacity: 25, floor_label: "1/F", x: 85, y: 55 },
            { room_id: "105", name: "Huddle Room Epsilon", name_zh: "戊級討論室", max_capacity: 8, floor_label: "1/F", x: 30, y: 60 },
            { room_id: "Court", name: "Gymnasium Court", name_zh: "體育館", max_capacity: 100, floor_label: "G/F", x: 50, y: 50 },
            { room_id: "G01", name: "Ground Floor Office", name_zh: "地下辦公室", max_capacity: 5, floor_label: "G/F", x: 20, y: 80 },
            { room_id: "LGB", name: "Lower Ground Breakout", name_zh: "地庫分組討論", max_capacity: 10, floor_label: "LG/F", x: 90, y: 90 },
            { room_id: "R01", name: "Rooftop Garden", name_zh: "屋頂花園", max_capacity: 20, floor_label: "R/F", x: 10, y: 90 },
            { room_id: "B01", name: "Basement Server Bay", name_zh: "地下室伺服器機房", max_capacity: 5, floor_label: "B1/F", x: 90, y: 10 },
        ];

        const FLOOR_PLANS = {
            'G/F': {
                label: 'G/F',
                image: 'https://placehold.co/800x600/b0e0e6/2c3e50?text=Ground+Floor+Plan+(G/F)',
                rooms: ROOM_CONFIG.filter(r => r.floor_label === 'G/F'),
            },
            '1/F': {
                label: '1/F',
                image: 'https://placehold.co/800x600/add8e6/2c3e50?text=First+Floor+Plan+(1/F)',
                rooms: ROOM_CONFIG.filter(r => r.floor_label === '1/F'),
            }
        };

        const API_URL = 'https://haydenalt.github.io/capacitydashboard/data.json';

        let currentRoomData = new Map();
        let currentLang = 'en';
        let currentFloor = '1/F';

        function translate(key) {
            return TRANSLATIONS[currentLang][key] || key;
        }

        async function fetchOccupancyData() {
            const response = await fetch(API_URL);
            
            if (!response.ok) {
                const text = await response.text();
                console.error("Non-OK response body:", text);
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            try {
                const apiOccupancy = await response.json();
                if (!Array.isArray(apiOccupancy)) {
                    throw new Error("API response is not an array.");
                }
                return apiOccupancy;
            } catch (error) {
                console.error("Critical error during standard JSON parsing:", error);
                throw new Error(`JSON Parsing Error: ${error.message}`);
            }
        }
        
        function getBarColor(percentage) {
            if (percentage < 50) return '#10B981';
            if (percentage <= 80) return '#F59E0B';
            return '#EF4444';
        }

        function getMarkerColor(percentage) {
            if (percentage < 50) return 'rgb(16, 185, 129)';
            if (percentage <= 80) return 'rgb(245, 158, 11)';
            return 'rgb(239, 68, 68)';
        }

        function mergeData(occupancyData) {
            const newRoomData = new Map();
            const configMap = new Map(ROOM_CONFIG.map(config => [config.room_id, config]));

            occupancyData.forEach(occupancy => {
                const config = configMap.get(occupancy.room_id);

                if (config) {
                    const current_occupancy = occupancy.current_occupancy;
                    const percentage = config.max_capacity > 0 
                        ? Math.min(100, Math.round((current_occupancy / config.max_capacity) * 100))
                        : 0;

                    const merged = {
                        ...config,
                        current_occupancy,
                        percentage,
                        color: getMarkerColor(percentage)
                    };
                    newRoomData.set(occupancy.room_id, merged);
                }
            });
            currentRoomData = newRoomData;
            renderFloor(currentFloor);
        }

        function renderFloor(floorKey) {
            currentFloor = floorKey;
            const floorPlanData = FLOOR_PLANS[floorKey];
            const mapContainer = document.getElementById('map-container');
            
            mapContainer.innerHTML = `
                <img id="floor-plan-image" src="${floorPlanData.image}" alt="${floorKey} Floor Plan" class="floor-plan" />
                <div id="room-markers"></div>
            `;
            
            const markerContainer = document.getElementById('room-markers');

            floorPlanData.rooms.forEach(roomConfig => {
                const roomData = currentRoomData.get(roomConfig.room_id);
                if (!roomData) return;

                const marker = document.createElement('div');
                marker.className = 'room-marker';
                marker.id = `marker-${roomConfig.room_id}`;
                marker.style.left = `${roomConfig.x}%`;
                marker.style.top = `${roomConfig.y}%`;
                marker.style.backgroundColor = roomData.color;
                marker.style.setProperty('--marker-color', roomData.color);
                marker.title = `${roomData.name} (${roomData.percentage}%)`;

                marker.addEventListener('click', () => {
                    displayRoomDetails(roomConfig.room_id);
                });

                markerContainer.appendChild(marker);
            });

            const selectedRoomId = mapContainer.dataset.selectedRoom;
            if (selectedRoomId) {
                displayRoomDetails(selectedRoomId);
            } else {
                displayRoomDetails(null);
            }
        }

        function displayRoomDetails(roomId) {
            const detailsCard = document.getElementById('room-details-card');
            const mapContainer = document.getElementById('map-container');
            const t = TRANSLATIONS[currentLang];
            
            document.querySelectorAll('.room-marker').forEach(m => m.classList.remove('room-marker-blink'));

            if (!roomId || !currentRoomData.has(roomId)) {
                detailsCard.innerHTML = `<p class="p-6 text-center text-gray-500">${t.no_room_selected}</p>`;
                mapContainer.dataset.selectedRoom = '';
                return;
            }

            const room = currentRoomData.get(roomId);
            const roomName = currentLang === 'zh' ? room.name_zh : room.name;

            const marker = document.getElementById(`marker-${roomId}`);
            if(marker) {
                 marker.classList.add('room-marker-blink');
            }

            mapContainer.dataset.selectedRoom = roomId;

            const barColor = getBarColor(room.percentage);

            detailsCard.innerHTML = `
                <div class="p-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">${roomName}</h2>
                    
                    <div class="grid grid-cols-2 gap-y-2 mb-6 text-lg">
                        <div class="text-gray-500">${t.floor}:</div>
                        <div class="text-gray-800 font-semibold">${room.floor_label}</div>
                        
                        <div class="text-gray-500">${t.room_id_label}:</div>
                        <div class="text-gray-800 font-semibold">${room.room_id}</div>
                        
                        <div class="text-gray-500">${t.capacity_label}:</div>
                        <div class="text-gray-800 font-semibold">${room.max_capacity} ${t.people_label}</div>
                    </div>
                    
                    <div class="flex flex-col space-y-3">
                        <div class="flex justify-between items-center">
                            <div class="text-xl font-medium text-gray-700">
                                ${t.current_occupancy}: 
                                <span class="text-3xl font-extrabold" style="color: ${barColor};">${room.current_occupancy}</span>
                                /${room.max_capacity}
                            </div>
                            <div class="text-3xl font-extrabold text-gray-900 bg-gray-100 px-3 py-1 rounded-lg">${room.percentage}%</div>
                        </div>

                        <div class="w-full h-4 bg-gray-200 rounded-full overflow-hidden">
                            <div 
                                class="h-full rounded-full transition-all duration-500" 
                                style="width: ${room.percentage}%; background-color: ${barColor};"
                            ></div>
                        </div>
                    </div>
                </div>
            `;
        }

        function setLanguage() {
            const newLang = document.getElementById('lang-dropdown').value;
            if (TRANSLATIONS[newLang]) {
                currentLang = newLang;
                
                document.getElementById('header-title').textContent = translate('title');
                document.getElementById('header-subtitle').textContent = translate('subtitle');
                document.getElementById('refresh-button-text').textContent = translate('refresh_data');
                document.getElementById('loading-indicator').textContent = translate('loading');
                document.getElementById('floor-select-label').textContent = translate('select_floor');
                document.getElementById('details-title').textContent = translate('room_details');
                document.getElementById('list-view-mode-button').textContent = translate('list_view_mode');

                document.querySelector('#floor-dropdown option[value="1/F"]').textContent = translate('floor_1');
                document.querySelector('#floor-dropdown option[value="G/F"]').textContent = translate('floor_G');
                
                renderFloor(currentFloor);
                
                const selectedRoomId = document.getElementById('map-container').dataset.selectedRoom;
                displayRoomDetails(selectedRoomId);
            }
        }

        async function refreshData() {
            const refreshButton = document.getElementById('refresh-button');
            const loadingIndicator = document.getElementById('loading-indicator');
            const mapContainer = document.getElementById('map-container');

            refreshButton.disabled = true;
            loadingIndicator.classList.remove('hidden');

            try {
                const occupancyData = await fetchOccupancyData();
                mergeData(occupancyData);
            } catch (error) {
                console.error("Critical error during data processing:", translate('error_api'), error);
                mapContainer.innerHTML = `<div class="text-center text-red-500 py-8 font-semibold">${translate('error_loading')}</div>`;
            } finally {
                refreshButton.disabled = false;
                loadingIndicator.classList.add('hidden');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const langDropdown = document.getElementById('lang-dropdown');
            const floorDropdown = document.getElementById('floor-dropdown');

            setLanguage();
            
            langDropdown.addEventListener('change', setLanguage);
            floorDropdown.addEventListener('change', (e) => {
                renderFloor(e.target.value);
            });
            document.getElementById('refresh-button').addEventListener('click', refreshData);
            
            refreshData(); 
        });
    </script>
</head>
<body class="p-4 sm:p-6 min-h-screen">

    <div class="max-w-4xl mx-auto">
        
        <header class="mb-6 border-b pb-4 flex justify-between items-start">
            <div>
                <h1 id="header-title" class="text-3xl font-extrabold text-gray-900 mb-1">Interactive Occupancy Monitor</h1>
                <p id="header-subtitle" class="text-gray-500">Select a floor plan and click on a room to view real-time capacity.</p>
            </div>
            
            <div class="flex flex-col space-y-2 sm:space-y-0 sm:flex-row sm:space-x-3 items-end">
                <a id="list-view-link" href="https://haydenalt.github.io/capacitydashboard/" class="flex items-center justify-center bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold text-sm py-2 px-3 rounded-xl transition duration-200 shadow-sm">
                    <svg class="w-4 h-4 mr-1.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="8" y1="6" x2="21" y2="6"></line>
                        <line x1="8" y1="12" x2="21" y2="12"></line>
                        <line x1="8" y1="18" x2="21" y2="18"></line>
                        <line x1="3" y1="6" x2="3.01" y2="6"></line>
                        <line x1="3" y1="12" x2="3.01" y2="12"></line>
                        <line x1="3" y1="18" x2="3.01" y2="18"></line>
                    </svg>
                    <span id="list-view-mode-button">List View Mode</span>
                </a>
                
                <select id="lang-dropdown" class="text-sm font-semibold rounded-xl px-3 py-2 border border-gray-300 text-gray-800 bg-white shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200">
                    <option value="en">English</option>
                    <option value="zh">中文</option>
                </select>
            </div>
        </header>

        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 space-y-4 sm:space-y-0">
            
            <div class="flex space-x-2 w-full sm:w-auto items-center">
                <span id="floor-select-label" class="text-sm font-medium text-gray-600 self-center">Select Floor:</span>
                
                <select id="floor-dropdown" class="text-sm font-semibold rounded-xl px-3 py-2 border border-indigo-600 text-indigo-800 bg-white shadow-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200">
                    <option value="1/F" selected>1st Floor (1/F)</option> 
                    <option value="G/F">Ground Floor (G/F)</option>
                </select>
            </div>
            
            <div class="flex items-center space-x-2 w-full sm:w-auto">
                <button id="refresh-button" class="flex items-center justify-center bg-indigo-500 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-xl transition duration-200 shadow-lg w-full sm:w-auto disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21.5 2v6h-6"/>
                        <path d="M2.5 22v-6h6"/>
                        <path d="M2.5 13a9 9 0 0 1 15.6-6.6l3.4-3.4"/>
                        <path d="M21.5 11a9 9 0 0 1-15.6 6.6l-3.4 3.4"/>
                    </svg>
                    <span id="refresh-button-text">Refresh Data</span>
                </button>
                <span id="loading-indicator" class="hidden text-sm font-medium text-indigo-600">
                    Loading...
                </span>
            </div>
        </div>

        <div id="map-container" class="floor-plan-container mb-8" data-selected-room="">
            <div class="text-center text-gray-500 py-8">Loading floor plan...</div>
        </div>

        <div class="bg-white rounded-xl shadow-2xl border border-gray-200">
            <h3 id="details-title" class="text-xl font-bold text-gray-800 p-4 border-b">Room Details</h3>
            <div id="room-details-card" class="min-h-[100px] flex items-center justify-center">
                <p class="p-6 text-center text-gray-500">Click on a room marker on the map to see its details.</p>
            </div>
        </div>

    </div>

</body>
</html>
