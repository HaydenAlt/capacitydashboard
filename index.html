<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HPCCSS Room Capacity Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f7fafc;
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #a0aec0;
            border-radius: 4px;
        }
    </style>
    <script>
        const TRANSLATIONS = {
            'en': {
                'title': 'Live Occupancy Monitor',
                'subtitle': 'Real-time room capacity status. Click refresh to update.',
                'refresh_data': 'Refresh Data',
                'loading': 'Loading...',
                'fetching_data': 'Fetching real-time data...',
                'error_loading': 'Error loading data. Find us in stem lab.',
                'sort_by': 'Sort By:',
                'option_default': 'Default',
                'option_percentage': '% Full',
                'option_people': 'People',
                'direction_asc': 'Ascending',
                'direction_desc': 'Descending',
                'floor': 'Floor',
                'room_id_label': 'Room ID',
                'capacity_label': 'Capacity',
                'people_label': 'people',
                'error_api': 'Error fetching data from API.',
                'floor_view_mode': 'Floor View Mode'
            },
            'zh': {
                'title': '實時房間佔用監控',
                'subtitle': '實時房間容量狀態。點擊刷新即可更新。',
                'refresh_data': '刷新數據',
                'loading': '載入中...',
                'fetching_data': '正在獲取實時數據...',
                'error_loading': '載入數據錯誤。請在 stem lab 找到我們。',
                'sort_by': '排序方式：',
                'option_default': '默認順序',
                'option_percentage': '佔用百分比',
                'option_people': '人數',
                'direction_asc': '升序',
                'direction_desc': '降序',
                'floor': '樓層',
                'room_id_label': '房間編號',
                'capacity_label': '容量',
                'people_label': '人',
                'error_api': '從 API 獲取數據錯誤。',
                'floor_view_mode': '樓層視圖模式'
            }
        };

        const STATIC_ROOM_CONFIG = [
            { room_id: "101", name: "Training Room Alpha", name_zh: "甲級培訓室", max_capacity: 10, floor_label: "1/F" },
            { room_id: "102", name: "Meeting Room Beta", name_zh: "乙級會議室", max_capacity: 15, floor_label: "1/F" },
            { room_id: "103", name: "Studio Gamma", name_zh: "丙級工作室", max_capacity: 20, floor_label: "1/F" },
            { room_id: "104", name: "Lounge Delta", name_zh: "丁級休息室", max_capacity: 25, floor_label: "1/F" },
            { room_id: "105", name: "Huddle Room Epsilon", name_zh: "戊級討論室", max_capacity: 8, floor_label: "1/F" },
            { room_id: "Court", name: "Gymnasium Court", name_zh: "體育館", max_capacity: 100, floor_label: "G/F" },
            { room_id: "G01", name: "Ground Floor Office", name_zh: "地下辦公室", max_capacity: 5, floor_label: "G/F" },
            { room_id: "LGB", name: "Lower Ground Breakout", name_zh: "地庫分組討論", max_capacity: 10, floor_label: "LG/F" },
            { room_id: "R01", name: "Rooftop Garden", name_zh: "屋頂花園", max_capacity: 20, floor_label: "R/F" },
            { room_id: "B01", name: "Basement Server Bay", name_zh: "地下室伺服器機房", max_capacity: 5, floor_label: "B1/F" },
        ];

        const API_URL = 'https://haydenalt.github.io/capacitydashboard/data.json';
        const FLOOR_VIEW_URL = 'https://haydenalt.github.io/capacitydashboard/floorview';

        let currentRoomData = [];
        let currentSortKey = 'api_order';
        let currentSortDirection = 'asc'; 
        let currentLang = 'en';

        function translate(key) {
            return TRANSLATIONS[currentLang][key] || key;
        }

        async function fetchOccupancyData() {
            const response = await fetch(API_URL);
            
            if (!response.ok) {
                const text = await response.text();
                console.error("Non-OK response body:", text);
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            try {
                const apiOccupancy = await response.json();
                if (!Array.isArray(apiOccupancy)) {
                    throw new Error("API response is not an array.");
                }
                return apiOccupancy;
            } catch (error) {
                console.error("Critical error during standard JSON parsing:", error);
                throw new Error(`JSON Parsing Error: ${error.message}`);
            }
        }
        
        function getMergedRoomData(occupancyData) {
            const configMap = new Map(STATIC_ROOM_CONFIG.map(config => [config.room_id, config]));

            return occupancyData
                .map((occupancy, index) => {
                    const config = configMap.get(occupancy.room_id);

                    if (!config) return null; 

                    const current_occupancy = occupancy.current_occupancy;
                    
                    const percentage = config.max_capacity > 0 
                        ? Math.min(100, Math.round((current_occupancy / config.max_capacity) * 100))
                        : 0;

                    let colorClass = 'bg-gray-100 border-gray-300';

                    if (percentage === 0) {
                        colorClass = 'bg-green-50 border-green-400';
                    } else if (percentage < 50) {
                        colorClass = 'bg-green-100 border-green-500';
                    } else if (percentage <= 80) {
                        colorClass = 'bg-amber-100 border-amber-500';
                    } else {
                        colorClass = 'bg-red-100 border-red-500';
                    }

                    return {
                        ...config,
                        current_occupancy,
                        percentage,
                        colorClass,
                        api_index: index
                    };
                })
                .filter(room => room !== null);
        }

        function renderRooms(rooms) {
            const listContainer = document.getElementById('room-list');
            listContainer.innerHTML = '';
            
            const roomNameKey = currentLang === 'zh' ? 'name_zh' : 'name';
            const t = TRANSLATIONS[currentLang];

            rooms.forEach(room => {
                const listItem = document.createElement('div');
                listItem.className = `p-4 mb-3 rounded-xl shadow-md transition-all duration-300 ease-in-out ${room.colorClass} border-l-4`;
                
                const roomName = room[roomNameKey] || room.name;

                listItem.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-grow">
                            <h2 class="text-lg font-bold text-gray-800">${roomName}</h2>
                            <p class="text-sm text-gray-500">
                                ${t.floor}: ${room.floor_label} | ${t.room_id_label}: ${room.room_id} | ${t.capacity_label}: ${room.max_capacity}
                            </p>
                        </div>
                        <div class="flex-shrink-0 ml-4 text-right">
                            <p class="text-2xl font-extrabold text-gray-900">${room.percentage}%</p>
                            <p class="text-sm text-gray-600">${room.current_occupancy} ${t.people_label}</p>
                        </div>
                    </div>
                    <div class="w-full h-2 mt-3 bg-gray-200 rounded-full overflow-hidden">
                        <div 
                            class="h-full rounded-full transition-all duration-500" 
                            style="width: ${room.percentage}%; background-color: ${getBarColor(room.percentage)};"
                            >
                        </div>
                    </div>
                `;
                listContainer.appendChild(listItem);
            });
            if (rooms.length === 0) {
                 listContainer.innerHTML = `<div class="text-center text-gray-500 py-8">${translate('fetching_data')}</div>`;
            }
        }

        function getBarColor(percentage) {
            if (percentage < 50) return '#10B981';
            if (percentage <= 80) return '#F59E0B'; 
            return '#EF4444';
        }

        function sortRooms(optionalKey = null) {
            const dropdown = document.getElementById('sort-key-dropdown');
            const newKey = dropdown.value;

            if (optionalKey && optionalKey !== currentSortKey) {
                currentSortKey = optionalKey;
            } else if (newKey !== currentSortKey) {
                currentSortKey = newKey;
            }

            updateSortControlsUI(currentSortKey, currentSortDirection);

            currentRoomData.sort((a, b) => {
                let valA, valB;

                switch (currentSortKey) {
                    case 'people':
                        valA = a.current_occupancy;
                        valB = b.current_occupancy;
                        return currentSortDirection === 'asc' ? valA - valB : valB - valA;

                    case 'percentage':
                        valA = a.percentage;
                        valB = b.percentage;
                        return currentSortDirection === 'asc' ? valA - valB : valB - valA;

                    case 'api_order':
                        valA = a.api_index;
                        valB = b.api_index;
                        return currentSortDirection === 'asc' ? valA - valB : valB - valA; 

                    default:
                        return 0;
                }
            });

            renderRooms(currentRoomData);
        }

        function toggleSortDirection() {
            currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            sortRooms(currentSortKey); 
        }

        function updateSortControlsUI(key, direction) {
            const dropdown = document.getElementById('sort-key-dropdown');
            dropdown.value = key;

            const icon = document.getElementById('direction-icon');
            const text = document.getElementById('direction-text');

            if (direction === 'asc') {
                text.textContent = translate('direction_asc');
                icon.style.transform = 'rotate(180deg)'; 
            } else {
                text.textContent = translate('direction_desc');
                icon.style.transform = 'rotate(0deg)'; 
            }
        }

        function setLanguage(lang) {
            const newLang = document.getElementById('lang-dropdown').value;
            if (TRANSLATIONS[newLang]) {
                currentLang = newLang;
                
                document.getElementById('header-title').textContent = translate('title');
                document.getElementById('header-subtitle').textContent = translate('subtitle');
                document.getElementById('refresh-button-text').textContent = translate('refresh_data');
                document.getElementById('loading-indicator').textContent = translate('loading');
                document.getElementById('sort-by-label').textContent = translate('sort_by');
                document.getElementById('floor-view-button-text').textContent = translate('floor_view_mode');

                document.querySelector('#sort-key-dropdown option[value="api_order"]').textContent = translate('option_default');
                document.querySelector('#sort-key-dropdown option[value="percentage"]').textContent = translate('option_percentage');
                document.querySelector('#sort-key-dropdown option[value="people"]').textContent = translate('option_people');
                
                updateSortControlsUI(currentSortKey, currentSortDirection);
                renderRooms(currentRoomData);
            }
        }

        async function refreshData() {
            const refreshButton = document.getElementById('refresh-button');
            const loadingIndicator = document.getElementById('loading-indicator');
            const listContainer = document.getElementById('room-list');

            refreshButton.disabled = true;
            loadingIndicator.classList.remove('hidden');
            
            listContainer.innerHTML = `<div class="text-center text-gray-500 py-8">${translate('fetching_data')}</div>`;

            try {
                const occupancyData = await fetchOccupancyData();
                currentRoomData = getMergedRoomData(occupancyData);
                
                sortRooms(currentSortKey); 
            } catch (error) {
                console.error("Critical error during data processing:", translate('error_api'), error);
                listContainer.innerHTML = `<div class="text-center text-red-500 py-8 font-semibold">${translate('error_loading')}</div>`;
            } finally {
                refreshButton.disabled = false;
                loadingIndicator.classList.add('hidden');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const langDropdown = document.getElementById('lang-dropdown');
            const sortDropdown = document.getElementById('sort-key-dropdown');
            const toggleButton = document.getElementById('sort-direction-toggle');

            setLanguage(currentLang);

            langDropdown.addEventListener('change', setLanguage);
            sortDropdown.addEventListener('change', () => { sortRooms(); });
            toggleButton.addEventListener('click', toggleSortDirection);
            document.getElementById('refresh-button').addEventListener('click', refreshData);
            
            refreshData(); 
        });
    </script>
</head>
<body class="p-4 sm:p-6 min-h-screen">

    <div class="max-w-4xl mx-auto">
        
        <header class="mb-6 border-b pb-4 flex justify-between items-start">
            <div>
                <h1 id="header-title" class="text-3xl font-extrabold text-gray-900 mb-1">Live Occupancy Monitor</h1>
                <p id="header-subtitle" class="text-gray-500">Real-time room capacity status. Click refresh to update.</p>
            </div>
            
            <div class="flex flex-col space-y-2 sm:space-y-0 sm:flex-row sm:space-x-3 items-end">
                <a href="https://haydenalt.github.io/capacitydashboard/floorview" class="flex items-center justify-center bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold text-sm py-2 px-3 rounded-xl transition duration-200 shadow-sm">
                    <svg class="w-4 h-4 mr-1.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M2 17l10 5 10-5M2 12l10 5 10-5M12 2v20"/>
                    </svg>
                    <span id="floor-view-button-text">Floor View Mode</span>
                </a>
                <select id="lang-dropdown" class="text-sm font-semibold rounded-xl px-3 py-2 border border-gray-300 text-gray-800 bg-white shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200">
                    <option value="en">English</option>
                    <option value="zh">中文</option>
                </select>
            </div>
        </header>

        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 space-y-4 sm:space-y-0">
            
            <div class="flex space-x-2 w-full sm:w-auto items-center">
                <span id="sort-by-label" class="text-sm font-medium text-gray-600 self-center hidden sm:block">Sort By:</span>
                
                <select id="sort-key-dropdown" class="text-sm font-semibold rounded-xl px-3 py-2 border border-indigo-600 text-indigo-800 bg-white shadow-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200">
                    <option value="api_order" selected>Default</option> 
                    <option value="percentage">% Full</option>
                    <option value="people">People</option>
                </select>

                <button id="sort-direction-toggle" class="text-sm font-semibold rounded-xl px-3 py-2 border border-indigo-600 bg-indigo-600 text-white transition duration-200 flex items-center shadow-md hover:bg-indigo-700" aria-label="Toggle sort direction">
                    <span id="direction-text">Ascending</span>
                    <svg id="direction-icon" class="w-4 h-4 ml-2 transition-transform duration-300 transform rotate-180" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            
            <div class="flex items-center space-x-2 w-full sm:w-auto">
                <button id="refresh-button" class="flex items-center justify-center bg-indigo-500 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-xl transition duration-200 shadow-lg w-full sm:w-auto disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21.5 2v6h-6"/>
                        <path d="M2.5 22v-6h6"/>
                        <path d="M2.5 13a9 9 0 0 1 15.6-6.6l3.4-3.4"/>
                        <path d="M21.5 11a9 9 0 0 1-15.6 6.6l-3.4 3.4"/>
                    </svg>
                    <span id="refresh-button-text">Refresh Data</span>
                </button>
                <span id="loading-indicator" class="hidden text-sm font-medium text-indigo-600">
                    Loading...
                </span>
            </div>

        </div>

        <div id="room-list" class="mt-8">
            <div class="text-center text-gray-500 py-8">Loading initial data...</div>
        </div>

    </div>

</body>
</html>
